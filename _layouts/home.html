---
layout: default
---

{% assign newest = site.recipes | sort: "date" | reverse %}
{% assign featured = newest | first %}

<!-- Featured (Option B: wird per JS t√§glich ersetzt, Liquid bleibt als Fallback) -->
<div class="section">
  <div class="homeBigTitle">Heute</div>

  <a class="linkCard" id="todayLink" href="{{ featured.url | relative_url }}">
    <div class="card recipeCard cardHover homeFeatured">
      <span class="favBadge" id="todayFav" data-fav-badge data-recipe-id="{{ featured.url | relative_url }}" aria-hidden="true">‚òÖ</span>

      <div class="thumb homeFeaturedThumb" id="todayThumbWrap" {% unless featured.image %}style="display:none"{% endunless %}>
        <img
          class="thumbImg"
          id="todayImg"
          src="{% if featured.image %}{{ featured.image | relative_url }}{% endif %}"
          alt="{{ featured.title | escape }}"
          loading="lazy"
          decoding="async"
          style="width:100%;max-height:240px;object-fit:cover;display:block;"
        >
      </div>

      <div class="recipeTop">
        <h3 class="recipeTitle" id="todayTitle">{{ featured.title }}</h3>
        <span class="badge action" id="todayCat" {% unless featured.category %}style="display:none"{% endunless %}>
          {{ featured.category }}
        </span>
      </div>

      <div class="recipeMeta">
        <span id="todayTime" {% unless featured.time %}style="display:none"{% endunless %}>‚è± {{ featured.time }}</span>
        <span id="todayServings" {% unless featured.servings %}style="display:none"{% endunless %}>üçΩ {{ featured.servings }}</span>
      </div>
    </div>
  </a>
</div>

<!-- Recommendations -->
<div class="section">
  <div class="homeSectionHead">
    <div class="homeSectionTitle">F√ºr dich</div>
  </div>
  <div class="hScroll" id="forYouRow"></div>
</div>

<div class="section" id="freezerSection" hidden>
  <div class="homeSectionTitle">Aus der K√ºhltruhe</div>
  <div class="stack" id="freezerList"></div>
</div>

<!-- Favorites (replaces "Neueste Rezepte") -->
<div class="section">
  <div class="homeSectionHead">
    <div class="homeSectionTitle">Favoriten</div>
    <a class="homeAllLink" href="{{ '/rezeptindex/' | relative_url }}">Alle ‚Üí</a>
  </div>

  <div class="hScroll snapScroll" id="favoritesRow"></div>
  <div class="dots" id="favoritesDots" aria-hidden="true"></div>
</div>

<!-- All recipes payload for JS (Option B needs url + image) -->
<script type="application/json" id="allRecipesJson">
[
{% assign sorted2 = site.recipes | sort: "title" %}
{% for r in sorted2 %}
  {
    "id": "{{ r.url | relative_url }}",
    "url": "{{ r.url | relative_url }}",
    "title": {{ r.title | jsonify }},
    "category": {{ r.category | jsonify }},
    "time": {{ r.time | jsonify }},
    "servings": {{ r.servings | jsonify }},
    "tags": {{ r.tags | jsonify }},
    "image": "{% if r.image %}{{ r.image | relative_url }}{% endif %}"
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
]
</script>

<script defer src="{{ '/assets/home-reco.js' | relative_url }}?v={{ site.time | date: '%s' }}"></script>

<!-- Option B: daily deterministic "Heute" selection (same on all devices) -->
<script>
(function(){
  const elJson = document.getElementById('allRecipesJson');
  if(!elJson) return;

  let recipes = [];
  try { recipes = JSON.parse(elJson.textContent || '[]'); } catch(e) { return; }
  if(!Array.isArray(recipes) || recipes.length === 0) return;

  // UTC day key => same selection everywhere for the same day
  const dayKey = new Date().toISOString().slice(0,10); // YYYY-MM-DD

  function hashString(s){
    let h = 2166136261; // FNV-1a
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  const idx = hashString(dayKey) % recipes.length;
  const r = recipes[idx];

  const link = document.getElementById('todayLink');
  const fav  = document.getElementById('todayFav');
  const imgW = document.getElementById('todayThumbWrap');
  const img  = document.getElementById('todayImg');
  const ttl  = document.getElementById('todayTitle');
  const cat  = document.getElementById('todayCat');
  const t    = document.getElementById('todayTime');
  const s    = document.getElementById('todayServings');

  if(link && r.url) link.href = r.url;

  if(fav){
    fav.setAttribute('data-recipe-id', r.id || r.url || '');
  }

  if(ttl) ttl.textContent = r.title || '‚Äî';

  if(cat){
    if(r.category){ cat.textContent = r.category; cat.style.display = ''; }
    else { cat.style.display = 'none'; }
  }

  if(t){
    if(r.time){ t.textContent = `‚è± ${r.time}`; t.style.display = ''; }
    else { t.style.display = 'none'; }
  }

  if(s){
    if(r.servings){ s.textContent = `üçΩ ${r.servings}`; s.style.display = ''; }
    else { s.style.display = 'none'; }
  }

  if(imgW && img){
    if(r.image){
      img.src = r.image;
      img.alt = r.title || '';
      imgW.style.display = '';
    } else {
      imgW.style.display = 'none';
    }
  }

  // Trigger fav badge refresh if your code listens to storage events
  window.dispatchEvent(new Event('storage'));
})();
</script>

<!-- Render favorites into the "Favoriten" row (App‚ÄëStore style) -->
<script>
(function(){
  const host = document.getElementById('favoritesRow');
  const dataEl = document.getElementById('allRecipesJson');
  if(!host || !dataEl) return;

  const STORE_KEY = window.KOCHBUCH_STORE?.STORE_KEY || 'kochbuch.stats.v1';

  let recipes = [];
  try{ recipes = JSON.parse(dataEl.textContent || "[]"); }catch{}
  if(!Array.isArray(recipes)) recipes = [];

  const byId = new Map();
  const norm = (x)=> window.KOCHBUCH_STORE?.normalizeId ? window.KOCHBUCH_STORE.normalizeId(x) : String(x||"");
  for(const r of recipes){
    const id = norm(r.id || r.url);
    byId.set(id, r);
  }

  function getStats(){
    try{ return window.KOCHBUCH_STORE?.getStats?.() || JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
    catch{ return {}; }
  }

  function getFavList(){
    const stats = getStats();
    const fav = [];

    // v1: stats.recipes[id] = { favorite:true, favoriteAt:... }
    if(stats && stats.v === 1 && stats.recipes && typeof stats.recipes === "object"){
      for(const [idRaw, e] of Object.entries(stats.recipes)){
        if(!e || e.favorite !== true) continue;
        const id = norm(idRaw);
        fav.push({ id, favoriteAt: e.favoriteAt || null });
      }
    } else {
      // Legacy shapes
      for(const k of Object.keys(stats || {})){
        if(k === "favorites") continue;
        const e = stats[k];
        if(e && typeof e === "object" && e.favorite === true){
          fav.push({ id: norm(k), favoriteAt: e.favoriteAt || null });
        }
      }
      if(stats && stats.favorites && typeof stats.favorites === "object"){
        for(const k of Object.keys(stats.favorites)){
          if(stats.favorites[k] === true) fav.push({ id: norm(k), favoriteAt: null });
        }
      }
    }

    // De-dup
    const seen = new Set();
    const out = [];
    for(const x of fav){
      if(!x.id || seen.has(x.id)) continue;
      seen.add(x.id);
      out.push(x);
    }

    // Sort: favoriteAt desc if any timestamp, else title A-Z
    const anyTs = out.some(x=>!!x.favoriteAt);
    if(anyTs){
      out.sort((a,b)=>{
        const ta = a.favoriteAt ? Date.parse(a.favoriteAt) : 0;
        const tb = b.favoriteAt ? Date.parse(b.favoriteAt) : 0;
        if(tb !== ta) return tb - ta;
        const ra = byId.get(a.id)?.title || "";
        const rb = byId.get(b.id)?.title || "";
        return ra.localeCompare(rb, "de", { sensitivity:"base" });
      });
    }else{
      out.sort((a,b)=>{
        const ra = byId.get(a.id)?.title || "";
        const rb = byId.get(b.id)?.title || "";
        return ra.localeCompare(rb, "de", { sensitivity:"base" });
      });
    }

    return out;
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function renderEmpty(){
    host.innerHTML = `
      <div class="emptyState">
        <div class="emptyTitle">Noch keine Favoriten</div>
        <div class="emptyText">Markiere Rezepte mit ‚òÖ, damit sie hier erscheinen.</div>
        <a class="btnPrimary" href="${esc('{{ "/rezeptindex/" | relative_url }}')}">Rezepte entdecken</a>
      </div>
    `;
    initDots();
  }

  function cardHtml(r){
    const href = r.url || r.id;
    const img = r.image ? `
      <div class="thumb">
        <img class="thumbImg" src="${esc(r.image)}" alt="${esc(r.title)}" loading="lazy" decoding="async" width="800" height="500">
      </div>` : '';

    const cat = r.category ? `<span class="badge action">${esc(r.category)}</span>` : '';
    const time = r.time ? `<span>‚è± ${esc(r.time)}</span>` : '';
    const serv = r.servings ? `<span>üçΩ ${esc(r.servings)}</span>` : '';

    const debug = (new URLSearchParams(location.search).get("debug")==="1")
      ? `<div class="debugLine">id: ${esc(norm(r.id || r.url))}</div>`
      : '';

    return `
      <a class="linkCard hCard homeFavCard" href="${esc(href)}">
        <div class="card recipeCard cardHover snapItem">
          <span class="favBadge isFav" aria-hidden="true">‚òÖ</span>
          ${img}
          <div class="recipeTop">
            <h3 class="recipeTitle clamp2">${esc(r.title)}</h3>
            ${cat}
          </div>
          <div class="recipeMeta">
            ${time}
            ${serv}
          </div>
          ${debug}
        </div>
      </a>
    `;
  }

  function render(){
    const favList = getFavList();
    const rows = [];
    for(const f of favList){
      const r = byId.get(f.id);
      if(!r) continue;
      rows.push(cardHtml(r));
    }
    if(!rows.length) return renderEmpty();
    host.innerHTML = rows.join('');
    initDots();
  }

  function initDots(){
    const dots = document.getElementById("favoritesDots");
    if(!dots) return;
    const items = host.querySelectorAll(".homeFavCard");
    const count = items.length;
    if(count <= 1){ dots.innerHTML=""; return; }
    // Create simple dots; active dot updates on scroll
    dots.innerHTML = Array.from({length: Math.min(count, 8)}).map((_,i)=>`<span class="dot" data-i="${i}"></span>`).join("");
    const dotEls = dots.querySelectorAll(".dot");
    function setActive(i){
      dotEls.forEach((d,idx)=>d.classList.toggle("active", idx===i));
    }
    function onScroll(){
      const w = host.getBoundingClientRect().width || 1;
      const idx = Math.round(host.scrollLeft / w);
      setActive(Math.max(0, Math.min(dotEls.length-1, idx)));
    }
    host.addEventListener("scroll", onScroll, { passive:true });
    setActive(0);
  }

  render();

  window.addEventListener('storage', (e)=>{
    if(!e || !e.key) return;
    if(e.key === STORE_KEY) render();
  });
  window.addEventListener('kochbuch:stats', render);
})();;
</script>
