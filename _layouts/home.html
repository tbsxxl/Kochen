---
layout: default
---

{% assign newest = site.recipes | sort: "date" | reverse %}
{% assign featured = newest | first %}

<!-- Featured (Option B: wird per JS t√§glich ersetzt, Liquid bleibt als Fallback) -->
<div class="section">
  <div class="homeBigTitle">Heute</div>

  <a class="linkCard" id="todayLink" href="{{ featured.url | relative_url }}">
    <div class="card recipeCard cardHover homeFeatured">
      <span class="favBadge" id="todayFav" data-fav-badge data-recipe-id="{{ featured.url | relative_url }}" aria-hidden="true">‚òÖ</span>

      <div class="thumb homeFeaturedThumb" id="todayThumbWrap" {% unless featured.image %}style="display:none"{% endunless %}>
        <img
          class="thumbImg"
          id="todayImg"
          src="{% if featured.image %}{{ featured.image | relative_url }}{% endif %}"
          alt="{{ featured.title | escape }}"
          loading="lazy"
          decoding="async"
          style="width:100%;max-height:240px;object-fit:cover;display:block;"
        >
      </div>

      <div class="recipeTop">
        <h3 class="recipeTitle" id="todayTitle">{{ featured.title }}</h3>
        <span class="badge action" id="todayCat" {% unless featured.category %}style="display:none"{% endunless %}>
          {{ featured.category }}
        </span>
      </div>

      <div class="recipeMeta">
        <span id="todayTime" {% unless featured.time %}style="display:none"{% endunless %}>‚è± {{ featured.time }}</span>
        <span id="todayServings" {% unless featured.servings %}style="display:none"{% endunless %}>üçΩ {{ featured.servings }}</span>
      </div>
    </div>
  </a>
</div>

<!-- Recommendations -->
<div class="section">
  <div class="homeSectionHead">
    <div class="homeSectionTitle">F√ºr dich</div>
  </div>
  <div class="hScroll" id="forYouRow"></div>
</div>

<div class="section" id="freezerSection" hidden>
  <div class="homeSectionTitle">Aus der K√ºhltruhe</div>
  <div class="stack" id="freezerList"></div>
</div>

<!-- Favorites (replaces "Neueste Rezepte") -->
<div class="section">
  <div class="homeSectionHead">
    <div class="homeSectionTitle">Favoriten</div>
    <a class="homeAllLink" href="{{ '/rezeptindex/' | relative_url }}">Alle ‚Üí</a>
  </div>

  <div class="hScroll" id="favoritesRow"></div>
</div>

<!-- All recipes payload for JS (Option B needs url + image) -->
<script type="application/json" id="allRecipesJson">
[
{% assign sorted2 = site.recipes | sort: "title" %}
{% for r in sorted2 %}
  {
    "id": "{{ r.url | relative_url }}",
    "url": "{{ r.url | relative_url }}",
    "title": {{ r.title | jsonify }},
    "category": {{ r.category | jsonify }},
    "time": {{ r.time | jsonify }},
    "servings": {{ r.servings | jsonify }},
    "tags": {{ r.tags | jsonify }},
    "image": "{% if r.image %}{{ r.image | relative_url }}{% endif %}"
  }{% unless forloop.last %},{% endunless %}
{% endfor %}
]
</script>

<script defer src="{{ '/assets/home-reco.js' | relative_url }}?v={{ site.time | date: '%s' }}"></script>

<!-- Option B: daily deterministic "Heute" selection (same on all devices) -->
<script>
(function(){
  const elJson = document.getElementById('allRecipesJson');
  if(!elJson) return;

  let recipes = [];
  try { recipes = JSON.parse(elJson.textContent || '[]'); } catch(e) { return; }
  if(!Array.isArray(recipes) || recipes.length === 0) return;

  // UTC day key => same selection everywhere for the same day
  const dayKey = new Date().toISOString().slice(0,10); // YYYY-MM-DD

  function hashString(s){
    let h = 2166136261; // FNV-1a
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  const idx = hashString(dayKey) % recipes.length;
  const r = recipes[idx];

  const link = document.getElementById('todayLink');
  const fav  = document.getElementById('todayFav');
  const imgW = document.getElementById('todayThumbWrap');
  const img  = document.getElementById('todayImg');
  const ttl  = document.getElementById('todayTitle');
  const cat  = document.getElementById('todayCat');
  const t    = document.getElementById('todayTime');
  const s    = document.getElementById('todayServings');

  if(link && r.url) link.href = r.url;

  if(fav){
    fav.setAttribute('data-recipe-id', r.id || r.url || '');
  }

  if(ttl) ttl.textContent = r.title || '‚Äî';

  if(cat){
    if(r.category){ cat.textContent = r.category; cat.style.display = ''; }
    else { cat.style.display = 'none'; }
  }

  if(t){
    if(r.time){ t.textContent = `‚è± ${r.time}`; t.style.display = ''; }
    else { t.style.display = 'none'; }
  }

  if(s){
    if(r.servings){ s.textContent = `üçΩ ${r.servings}`; s.style.display = ''; }
    else { s.style.display = 'none'; }
  }

  if(imgW && img){
    if(r.image){
      img.src = r.image;
      img.alt = r.title || '';
      imgW.style.display = '';
    } else {
      imgW.style.display = 'none';
    }
  }

  // Trigger fav badge refresh if your code listens to storage events
  window.dispatchEvent(new Event('storage'));
})();
</script>

<!-- Render favorites into the "Favoriten" row (App‚ÄëStore style) -->
<script>
(function(){
  const host = document.getElementById('favoritesRow');
  const elJson = document.getElementById('allRecipesJson');
  if(!host || !elJson) return;

  let recipes = [];
  try { recipes = JSON.parse(elJson.textContent || '[]'); } catch(e) { return; }
  if(!Array.isArray(recipes) || recipes.length === 0) return;

  const STATS_KEY = 'kochbuch.stats';

  function normPath(x){
    try{
      x = String(x || '');
      x = x.replace(/^https?:\/\/[^/]+/i, '');
      x = x.split('#')[0].split('?')[0];
      if(x && x[0] !== '/') x = '/' + x;
      x = x.replace(/\/+/g, '/');
      return x;
    }catch{ return String(x || ''); }
  }

  function normalizeId(id){
    const raw = normPath(id);
    if(!raw) return '';
    // keep both variants to be tolerant across pages
    return raw.endsWith('/') ? raw : raw + '/';
  }

  function getStats(){
    try { return JSON.parse(localStorage.getItem(STATS_KEY) || '{}'); }
    catch { return {}; }
  }

  function readFavIds(){
    const stats = getStats();

    // A) stats[recipeId] = { favorite: true }
    const idsA = Object.keys(stats || {})
      .filter(k => k !== 'favorites')
      .filter(k => stats[k] && typeof stats[k] === 'object' && stats[k].favorite === true);

    // B) stats.favorites[recipeId] = true
    const idsB = Object.keys((stats && stats.favorites) || {})
      .filter(k => stats.favorites && stats.favorites[k] === true);

    // Merge + de-dup while preserving order (B first tends to be the newer shape)
    const out = [];
    const seen = new Set();
    [...idsB, ...idsA].forEach(id=>{
      const n = normalizeId(id);
      if(!n || seen.has(n)) return;
      seen.add(n);
      out.push(n);
    });
    return out;
  }

  const byId = new Map();
  recipes.forEach(r=>{
    if(r?.id) byId.set(normalizeId(r.id), r);
    if(r?.url) byId.set(normalizeId(r.url), r);
    // also map without trailing slash (tolerant)
    if(r?.id) byId.set(normPath(r.id), r);
    if(r?.url) byId.set(normPath(r.url), r);
  });

  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function render(){
    const favIds = readFavIds();
    if(!favIds.length){
      host.innerHTML = `<div class="sub" style="padding:6px 2px;">Keine Favoriten markiert.</div>`;
      return;
    }

    const favRecipes = favIds
      .map(id => byId.get(id) || byId.get(normPath(id)))
      .filter(Boolean);

    if(!favRecipes.length){
      host.innerHTML = `<div class="sub" style="padding:6px 2px;">Favoriten vorhanden, aber keine passenden Rezept-IDs gefunden.</div>`;
      return;
    }

    host.innerHTML = favRecipes.map(r=>{
      const href = r.url || r.id || '#';

      const img = r.image ? `
        <div class="thumb homeFavThumb">
          <img class="thumbImg" src="${esc(r.image)}" alt="${esc(r.title)}" loading="lazy" decoding="async">
        </div>` : '';

      const cat = r.category ? `<span class="badge action">${esc(r.category)}</span>` : '';
      const time = r.time ? `<span>‚è± ${esc(r.time)}</span>` : '';
      const serv = r.servings ? `<span>üçΩ ${esc(r.servings)}</span>` : '';

      return `
        <a class="linkCard hCard homeFavCard" href="${esc(href)}">
          <div class="card recipeCard cardHover">
            <span class="favBadge isFav" aria-hidden="true">‚òÖ</span>
            ${img}
            <div class="recipeTop">
              <h3 class="recipeTitle">${esc(r.title)}</h3>
              ${cat}
            </div>
            <div class="recipeMeta">
              ${time}
              ${serv}
            </div>
          </div>
        </a>
      `;
    }).join('');
  }

  render();

  // Update on storage changes (favorite toggles)
  window.addEventListener('storage', (e)=>{
    if(!e || !e.key) return;
    if(e.key === STATS_KEY) render();
  });

  // Optional: allow in-page updates (if you dispatch this event after toggling favorites)
  window.addEventListener('kochbuch:stats', render);
})();
</script>
