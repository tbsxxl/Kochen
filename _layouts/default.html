<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>{% if page.title %}{{ page.title }} Â· {% endif %}{{ site.title }}</title>
  <meta name="theme-color" content="#f6f7f9">
<link rel="icon" type="image/png" href="{{ '/assets/favicon-512.png' | relative_url }}">

  <!-- Wichtig: relative_url sorgt dafÃ¼r, dass es mit baseurl funktioniert -->
  <link rel="stylesheet" href="{{ '/assets/styles.css' | relative_url }}?v={{ site.time | date: '%s' }}">
  <script defer src="{{ '/assets/utils.js' | relative_url }}?v={{ site.time | date: '%s' }}"></script>
</head>
<body class="{% if page.layout %}layout-{{ page.layout }}{% endif %}">
  <!-- iPhone-friendly Topbar: Back + Title only -->
  <header class="iosTopbar" id="iosTopbar">
    <div class="container iosTopbarInner">
      <button class="navIconBtn pressable" id="backBtn" aria-label="ZurÃ¼ck" type="button">â€¹</button>

      <div class="iosTopTitleWrap">
        <div class="iosTopTitle">{% if page.title %}{{ page.title }}{% else %}{{ site.title }}{% endif %}</div>
      </div>

      <!-- spacer to keep title centered on iOS-style bars -->
      <span aria-hidden="true" style="width:44px;height:44px;display:inline-block"></span>
    </div>
  </header>

  <main class="container appMain" role="main">
    {{ content }}
  </main>

  <!-- Bottom Tabbar -->
  {% unless page.layout == "recipe" %}
<nav class="tabbar bottomRail" aria-label="Navigation">
    <div class="tabbarInner container">
      <a class="tabItem" data-tab href="{{ '/' | relative_url }}">
        <span class="tabIcon">âŒ‚</span><span class="tabLabel">Start</span>
      </a>

      <a class="tabItem" data-tab href="{{ '/rezeptindex/' | relative_url }}">
        <span class="tabIcon">ğŸ²</span><span class="tabLabel">Rezepte</span>
      </a>

      <a class="tabItem" data-tab href="{{ '/shopping/' | relative_url }}">
        <span class="tabIcon">ğŸ›’</span><span class="tabLabel">Liste</span>
      </a>

      <button class="tabItem tabMore" id="moreBtn" aria-label="Mehr" type="button">
        <span class="tabIcon">â‹¯</span><span class="tabLabel">Mehr</span>
      </button>
    </div>
  </nav>
{% endunless %}

  <!-- Bottom Sheet: Mehr -->
  <div class="sheetOverlay" id="sheetOverlay"></div>
  <section class="sheet" id="sheet" aria-label="Mehr-MenÃ¼" aria-hidden="true">
    <div class="sheetGrab"></div>
    <div class="sheetHead">
      <div class="sheetTitle">Mehr</div>
      <button class="navIconBtn pressable" id="sheetClose" aria-label="SchlieÃŸen" type="button">âœ•</button>
    </div>

    <div class="sheetBody">
      <a class="sheetRow" href="{{ '/kuehltruhe/' | relative_url }}">ğŸ§Š KÃ¼hltruhe</a>
      <a class="sheetRow" href="{{ '/kategorien/' | relative_url }}">ğŸ· Kategorien</a>
      <a class="sheetRow" href="{{ '/admin/' | relative_url }}">âš™ï¸ Admin</a>
      <a class="sheetRow" href="{{ '/backup/' | relative_url }}">â¬‡ï¸ Backup / Import</a>
      <div class="sheetSep"></div>
      <button class="sheetRow" id="toggleCompact" type="button">â†•ï¸ Compact Mode</button>
      <button class="sheetRow" id="toggleContrast" type="button">â— High Contrast</button>
    </div>
  </section>

  <script>
  (function(){
    // Back Button
    const backBtn = document.getElementById('backBtn');
    if (history.length > 1) backBtn.addEventListener('click', ()=>history.back());
    else backBtn.style.visibility = 'hidden';

    // Topbar density on scroll (iOS-like)
    const topbar = document.getElementById('iosTopbar');
    const onScroll = ()=>{ topbar?.classList.toggle('scrolled', (window.scrollY||0) > 4); };
    window.addEventListener('scroll', onScroll, { passive:true });
    onScroll();

    // Active Tab Highlight
    const path = location.pathname.replace(/\/+$/,'') || "/";
    const recipeBase = "{{ '/rezepte/' | relative_url }}".replace(/\/+$/,'');
    const recipeIndex = "{{ '/rezeptindex/' | relative_url }}".replace(/\/+$/,'');

    document.querySelectorAll('[data-tab]').forEach(a=>{
      const href = new URL(a.getAttribute('href'), location.origin).pathname.replace(/\/+$/,'') || "/";
      if (href === path) a.classList.add('active');
      if (recipeBase && path.startsWith(recipeBase) && href === recipeIndex) a.classList.add('active');
    });

    // Mark "Mehr" as active for secondary pages
    const more = document.getElementById('moreBtn');
    const morePaths = [
      "{{ '/kuehltruhe/' | relative_url }}",
      "{{ '/kategorien/' | relative_url }}",
      "{{ '/admin/' | relative_url }}",
      "{{ '/backup/' | relative_url }}"
    ].map(p=>p.replace(/\/+$/,''));
    if (more && morePaths.some(p=>p && path.startsWith(p))) more.classList.add('active');

    // Sheet open/close
    const moreBtn = document.getElementById('moreBtn');
    const overlay = document.getElementById('sheetOverlay');
    const sheet = document.getElementById('sheet');
    const closeBtn = document.getElementById('sheetClose');

    // iOS-like detents: half + full
    function setDetent(mode){
      sheet.classList.toggle('half', mode === 'half');
      sheet.classList.toggle('full', mode === 'full');
    }
    function openSheet(){ overlay.classList.add('open'); sheet.classList.add('open'); setDetent('half'); sheet.setAttribute('aria-hidden','false'); }
    function closeSheet(){ overlay.classList.remove('open'); sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }

    // Grabber toggles detents
    const grab = sheet?.querySelector('.sheetGrab');
    grab?.addEventListener('click', ()=>{
      if(!sheet.classList.contains('open')) return;
      setDetent(sheet.classList.contains('full') ? 'half' : 'full');
    });

    moreBtn?.addEventListener('click', openSheet);
    overlay?.addEventListener('click', closeSheet);
    closeBtn?.addEventListener('click', closeSheet);

    // Persisted toggles
    const get = (k,fb)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fb; }catch{return fb;} };
    const set = (k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} };

    const compactKey="kochbuch.ui.compact";
    const contrastKey="kochbuch.ui.contrast";

    function apply(){
      document.body.classList.toggle('compact', !!get(compactKey,false));
      document.body.classList.toggle('highContrast', !!get(contrastKey,false));
    }
    apply();

    document.getElementById('toggleCompact')?.addEventListener('click', ()=>{ set(compactKey,!get(compactKey,false)); apply(); });
    document.getElementById('toggleContrast')?.addEventListener('click', ()=>{ set(contrastKey,!get(contrastKey,false)); apply(); });
  })();
  </script>
</body>
</html>
